<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generatore Codice (QR1 → Codice)</title>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <link rel="preconnect" href="https://unpkg.com">
  <!-- Carica SEMPRE prima la libreria -->
  <script src="https://unpkg.com/html5-qrcode" defer></script>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    body { margin: 0; padding: 24px; background:#0b0f17; color:#eaf1ff; }
    .card { max-width: 720px; margin: 0 auto; background:#121826; border:1px solid #23314c; border-radius:16px; padding:20px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { margin-top:0; font-size: 1.5rem; }
    .muted { color:#a0b3d2; font-size: .95rem; }
    button { cursor:pointer; border:0; border-radius:12px; padding:12px 16px; font-weight:600; }
    .btn { background:#2a64ff; color:white; }
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .badge { display:inline-block; background:#1c2336; border:1px solid #2b3b5e; padding:6px 10px; border-radius:999px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    #codeBox { font-size:1.4rem; letter-spacing: .05em; padding:12px; background:#0f1422; border:1px dashed #35518f; border-radius:12px; min-height: 44px; display:flex; align-items:center; justify-content:center; }
    #status { margin-top:10px; }
    #error { margin-top:10px; color:#ffb4b4; white-space:pre-wrap; font-size:.9rem; }
    a { color:#84a9ff; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Generatore di Codice</h1>
    <p class="muted">
      Scansiona il <strong>QR1</strong> per convalidare l'azione. Se valido, verrà generato un codice alfanumerico (max 10) presente in <code>coords.json</code>.
      <br> Testo atteso nel QR1: <span class="badge" id="qr1-hint"></span>
    </p>

    <!-- PULSANTE NECESSARIO SU iOS PER PERMESSI FOTOCAMERA -->
    <button id="startScanner" class="btn">Avvia Scanner</button>

    <div id="reader" style="width: 100%; max-width: 420px; margin: 12px auto;"></div>
    <div id="status" class="muted"></div>
    <div id="error"></div>

    <div class="row" style="margin-top:16px;">
      <button id="btnGen" class="btn" disabled>Genera codice</button>
      <span id="loadedInfo" class="muted"></span>
    </div>

    <div id="codeBox" style="margin-top:16px;">—</div>

  </div>

  <!-- Metti lo script ALLA FINE del body, senza defer, così Html5Qrcode è già disponibile -->
  <script>
    // === Parametri configurabili ===
    const QR1_EXPECTED = "GEN_KEY_1"; // testo esatto del tuo QR1 fisso
    const COORDS_JSON = "./coords.json"; // percorso al file esterno

    const elHint = document.getElementById('qr1-hint');
    const elStatus = document.getElementById('status');
    const elError = document.getElementById('error');
    const btnStart = document.getElementById('startScanner');
    const btnGen = document.getElementById('btnGen');
    const codeBox = document.getElementById('codeBox');

    elHint.textContent = QR1_EXPECTED;

    let keys = [];
    let validated = false;
    let scanner = null;

    function updateStatus(msg) { elStatus.textContent = msg; }
    function showError(msg) { elError.textContent = msg; }

    async function loadKeys() {
      try {
        const res = await fetch(COORDS_JSON, { cache: 'no-store' });
        if (!res.ok) throw new Error('Impossibile caricare coords.json');
        const data = await res.json();
        keys = Object.keys(data || {});
        document.getElementById('loadedInfo').textContent = keys.length ? `${keys.length} codici disponibili` : 'Nessun codice in coords.json';
      } catch (e) {
        document.getElementById('loadedInfo').textContent = 'Errore nel caricamento di coords.json';
        showError(String(e));
        console.error(e);
      }
    }

    function pickRandomCode() {
      if (!keys.length) return null;
      const idx = Math.floor(Math.random() * keys.length);
      return keys[idx];
    }

    function showCode(code) { codeBox.textContent = code || '—'; }

    async function startScanner() {
      try {
        if (scanner) return; // evita doppio avvio
        // Verifica disponibilità API
        if (!window.Html5QrcodeScanner) {
          showError('Libreria html5-qrcode non caricata. Controlla la connessione o l\'URL dello script.');
          return;
        }
        scanner = new Html5QrcodeScanner('reader', { fps: 10, qrbox: 250, rememberLastUsedCamera: true });
        const onScanSuccess = (decodedText) => {
          if (validated) return;
          if (decodedText === QR1_EXPECTED) {
            validated = true;
            updateStatus('QR1 valido. Ora puoi generare un codice.');
            btnGen.disabled = false;
            scanner.clear().catch(()=>{});
          } else {
            updateStatus('QR non valido. Riprova.');
          }
        };
        const onScanFailure = (err) => { /* Ignora errori di decodifica continui */ };
        scanner.render(onScanSuccess, onScanFailure);
      } catch (e) {
        showError('Errore avvio scanner: ' + String(e));
        console.error(e);
      }
    }

    window.addEventListener('load', async () => {
      await loadKeys();
      btnStart.addEventListener('click', startScanner);
      btnGen.addEventListener('click', () => {
        if (!validated) return;
        const code = pickRandomCode();
        if (!code) { showCode('Nessun codice disponibile in coords.json'); return; }
        showCode(code);
      });
    });

    // Alternativa: generazione alfanumerica casuale (max 10)
    function generateRandom(minLen = 8, maxLen = 10) {
      const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      const len = Math.floor(Math.random() * (maxLen - minLen + 1)) + minLen;
      let out = '';
      for (let i = 0; i < len; i++) out += alphabet[Math.floor(Math.random() * alphabet.length)];
      return out;
    }
  </script>
</body>
</html>
