<!doctype html>
const COORDS_JSON = "./coords.json";
document.getElementById('qr2-hint').textContent = QR2_EXPECTED;


// Stato
let validated = false;
let coords = {};


async function loadCoords() {
try {
const res = await fetch(COORDS_JSON, { cache: 'no-store' });
if (!res.ok) throw new Error('Impossibile caricare coords.json');
coords = await res.json();
const n = Object.keys(coords || {}).length;
document.getElementById('loadedInfo').textContent = n ? `${n} coppie codiceâ†’coordinate caricate` : 'coords.json vuoto';
} catch (e) {
document.getElementById('loadedInfo').textContent = 'Errore nel caricamento di coords.json';
console.error(e);
}
}


function updateStatus(msg) { document.getElementById('status').textContent = msg; }


function tryShow() {
const btn = document.getElementById('btnCheck');
btn.disabled = !validated;
}


function showCoord(text) {
const box = document.getElementById('result');
const pre = document.getElementById('coordText');
pre.textContent = text;
box.style.display = 'block';
}


window.addEventListener('load', async () => {
await loadCoords();


const onScanSuccess = (decodedText) => {
if (validated) return;
if (decodedText === QR2_EXPECTED) {
validated = true;
updateStatus('QR2 valido. Ora inserisci il codice e premi verifica.');
tryShow();
scanner.clear().catch(()=>{});
} else {
updateStatus('QR non valido. Riprova.');
}
};


const onScanFailure = (error) => { /* silenzioso */ };


const scanner = new Html5QrcodeScanner('reader', { fps: 10, qrbox: 250, rememberLastUsedCamera: true });
scanner.render(onScanSuccess, onScanFailure);


document.getElementById('btnCheck').addEventListener('click', () => {
if (!validated) return;
const code = (document.getElementById('codeInput').value || '').trim().toUpperCase();
if (!code) { updateStatus('Inserisci un codice.'); return; }


// Regola di controllo: corrispondenza esatta col codice generato
// (Alternativa: applichi qui la stessa regola di decriptazione usata nella pagina 1)
const utm = coords[code];
if (!utm) { showCoord('Codice non trovato o non valido.'); return; }
showCoord(utm);
});
});
</script>
</body>
</html>