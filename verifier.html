<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verifica Codice (QR2 → Coordinate)</title>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <link rel="preconnect" href="https://unpkg.com">
  <script src="https://unpkg.com/html5-qrcode" defer></script>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    body { margin: 0; padding: 24px; background:#0b0f17; color:#eaf1ff; }
    .card { max-width: 720px; margin: 0 auto; background:#121826; border:1px solid #23314c; border-radius:16px; padding:20px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { margin-top:0; font-size: 1.5rem; }
    .muted { color:#a0b3d2; font-size: .95rem; }
    input[type="text"] { width:90%; padding:14px; border-radius:12px; border:1px solid #2b3b5e; background:#0f1422; color:#eaf1ff; font-size:1rem; }
    button { cursor:pointer; border:0; border-radius:12px; padding:12px 16px; font-weight:600; }
    .btn { background:#2a64ff; color:white; }
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .badge { display:inline-block; background:#1c2336; border:1px solid #2b3b5e; padding:6px 10px; border-radius:999px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .coord { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#0f1422; border:1px dashed #35518f; border-radius:12px; padding:12px; }
    #status { margin-top:10px; }
    #error { margin-top:10px; color:#ffb4b4; white-space:pre-wrap; font-size:.9rem; }
    a { color:#84a9ff; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Verifica Codice → Coordinate UTM/UPS</h1>
    <p class="muted">
      1) Scansiona il <strong>QR2</strong> per convalidare. 2) Inserisci il codice ricevuto. Se il codice è corretto, verranno mostrate le coordinate.
      <br>Testo atteso nel QR2: <span class="badge" id="qr2-hint"></span>
    </p>

    <button id="startScanner" class="btn">Avvia Scanner</button>

    <div id="reader" style="width: 100%; max-width: 420px; margin: 12px auto;"></div>
    <div id="status" class="muted"></div>
    <div id="error"></div>

    <div style="margin-top:16px;">
      <label for="codeInput" class="muted">Codice alfanumerico</label>
      <input id="codeInput" type="text" placeholder="Es. AB12CD34EF" autocomplete="off" maxlength="12" />
    </div>

    <div class="row" style="margin-top:16px;">
      <button id="btnCheck" class="btn" disabled>Verifica & Mostra Coordinate</button>
      <span id="loadedInfo" class="muted"></span>
    </div>

    <div id="result" style="margin-top:16px; display:none;">
      <div class="coord" id="coordText"></div>
      <p class="muted" style="margin-top:8px;">Formato restituito: <strong>UTM/UPS</strong> (esattamente come in <code>coords.json</code>).</p>
    </div>
  </div>

  <script>
    // === Parametri configurabili ===
    const QR2_EXPECTED = "VER_KEY_2"; // testo esatto del tuo QR2 fisso
    const COORDS_JSON = "./coords.json";
    document.getElementById('qr2-hint').textContent = QR2_EXPECTED;

    // Stato
    let validated = false;
    let coords = {};
    let scanner = null;

    function updateStatus(msg) { document.getElementById('status').textContent = msg; }
    function showError(msg) { document.getElementById('error').textContent = msg; }

    async function loadCoords() {
      try {
        const res = await fetch(COORDS_JSON, { cache: 'no-store' });
        if (!res.ok) throw new Error('Impossibile caricare coords.json');
        coords = await res.json();
        const n = Object.keys(coords || {}).length;
        document.getElementById('loadedInfo').textContent = n ? `${n} coppie codice→coordinate caricate` : 'coords.json vuoto';
      } catch (e) {
        document.getElementById('loadedInfo').textContent = 'Errore nel caricamento di coords.json';
        showError(String(e));
        console.error(e);
      }
    }

    async function startScanner() {
      try {
        if (scanner) return;
        if (!window.Html5QrcodeScanner) {
          showError('Libreria html5-qrcode non caricata. Controlla la connessione o l\'URL dello script.');
          return;
        }
        scanner = new Html5QrcodeScanner('reader', { fps: 10, qrbox: 250, rememberLastUsedCamera: true });
        const onScanSuccess = (decodedText) => {
          if (validated) return;
          if (decodedText === QR2_EXPECTED) {
            validated = true;
            updateStatus('QR2 valido. Ora inserisci il codice e premi verifica.');
            document.getElementById('btnCheck').disabled = false;
            scanner.clear().catch(()=>{});
          } else {
            updateStatus('QR non valido. Riprova.');
          }
        };
        const onScanFailure = (err) => { /* ignora errori continui */ };
        scanner.render(onScanSuccess, onScanFailure);
      } catch (e) {
        showError('Errore avvio scanner: ' + String(e));
        console.error(e);
      }
    }

    function showCoord(text) {
      const box = document.getElementById('result');
      const pre = document.getElementById('coordText');
      pre.textContent = text;
      box.style.display = 'block';
    }

    window.addEventListener('load', async () => {
      await loadCoords();
      document.getElementById('startScanner').addEventListener('click', startScanner);
      document.getElementById('btnCheck').addEventListener('click', () => {
        if (!validated) return;
        const code = (document.getElementById('codeInput').value || '').trim().toUpperCase();
        if (!code) { updateStatus('Inserisci un codice.'); return; }
        const utm = coords[code];
        if (!utm) { showCoord('Codice non trovato o non valido.'); return; }
        showCoord(utm);
      });
    });
  </script>
</body>
</html>
